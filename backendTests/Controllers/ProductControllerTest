using Xunit;
using Microsoft.EntityFrameworkCore;
using backend.Controllers;
using backend.Data;
using backend.Models;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;
using System;

namespace backendTests
{
    public class ProductControllerTests
    {
        
        // Deze functie maakt een 'In-Memory' database.
        
        private AppDbContext GetDatabaseContext()
        {
            var options = new DbContextOptionsBuilder<AppDbContext>()
                .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString()) // Guid zorgt voor een unieke naam per test
                .Options;

            var databaseContext = new AppDbContext(options);
            databaseContext.Database.EnsureCreated();
            
            return databaseContext;
        }

        [Fact]
        public async Task Admin_UpdateProductPrice_Should_Update_Price_In_Database()
        {
            // Arrange
            var dbContext = GetDatabaseContext();
            var testProduct = new Product
            {
                ProductID = 1,
                Naam = "Test Bloem",
                StartPrijs = 10,
                VerkoperID = "admin"
            };
            dbContext.Producten.Add(testProduct);
            await dbContext.SaveChangesAsync();

            var controller = new ProductController(dbContext);

            // Act
            var result = await controller.UpdateProductPrice(1, 25);

            // Assert
            Assert.IsType<OkObjectResult>(result);
            
            var dbProduct = await dbContext.Producten.FindAsync(1);
            Assert.Equal(25, dbProduct.StartPrijs);
        }
        [Fact]
        public async Task Admin_UpdateProductPrice_Should_Return_NotFound_If_ID_Is_Wrong()
        {
            
            
            var dbContext = GetDatabaseContext(); 
            var controller = new ProductController(dbContext);

            
            
            var result = await controller.UpdateProductPrice(99, 50);

            
            // We verwachten dat de controller zegt: "NotFound" (404)
            Assert.IsType<NotFoundResult>(result);
        }
        [Fact]
        public async Task UpdateProductPrice_MetNegatievePrijs_GeeftBadRequest()
        {
            
            var options = new DbContextOptionsBuilder<AppDbContext>()
                .UseInMemoryDatabase(databaseName: "TestDb_Negatief")
                .Options;

            // 2. Vul de database met één testproduct
            using (var context = new AppDbContext(options))
            {
                context.Producten.Add(new Product 
                { 
                    ProductID = 1,  
                    Naam = "Test Vaas", 
                    StartPrijs = 50 
                });
                await context.SaveChangesAsync();
            }

            
            using (var context = new AppDbContext(options))
            {
                var controller = new ProductController(context);

                // De veilingmeester probeert -10 euro in te voeren (FOUT)
                var result = await controller.UpdateProductPrice(1, -10);

                
                Assert.IsType<BadRequestObjectResult>(result);

                
                var productInDb = await context.Producten.FindAsync(1);
                Assert.Equal(50, productInDb.StartPrijs); 
            }
        }

        [Fact]
        public async Task UpdateProductPrice_MetGeldigePrijs_PastPrijsAan()
        {
            // --- ARRANGE ---
            // Nieuwe database naam = schone lei
            var options = new DbContextOptionsBuilder<AppDbContext>()
                .UseInMemoryDatabase(databaseName: "TestDb_Positief") 
                .Options;

            using (var context = new AppDbContext(options))
            {
                context.Producten.Add(new Product 
                { 
                    ProductID = 1, 
                    Naam = "Test Vaas", 
                    StartPrijs = 50 
                });
                await context.SaveChangesAsync();
            }

            // --- ACT ---
            using (var context = new AppDbContext(options))
            {
                var controller = new ProductController(context);

                // De veilingmeester verandert de prijs naar 75 euro (GOED)
                var result = await controller.UpdateProductPrice(1, 75);

                // --- ASSERT ---
                
                // Check: Krijgen we een Ok (200) terug?
                Assert.IsType<OkObjectResult>(result);

                // Check: Is de prijs echt veranderd in de database?
                var productInDb = await context.Producten.FindAsync(1);
                Assert.Equal(75, productInDb.StartPrijs);
            }
        }
    }
}
        
        
